name: Deploy to Play Store

on:
  push:
    branches:
      - main

concurrency:
  group: release-playstore
  cancel-in-progress: true

jobs:

  # -------------------------------------
  # ğŸ·ï¸ PR Label Check - Release Internal
  # -------------------------------------
  label-check:
    uses: ./.github/workflows/trigger_release_internal.yml
    secrets: inherit

  # -------------------------------------
  # âœ… Testing - Unit & UI
  # -------------------------------------
  unit-tests:
    uses: ./.github/workflows/unit_test.yml
    needs: [label-check]

  ui-tests:
    uses: ./.github/workflows/ui_test.yml
    needs: [label-check]
    secrets: inherit

  # -------------------------------------
  # ğŸ”– Versioning - Read Current Version
  # -------------------------------------
  get-current-version:
    uses: ./.github/workflows/app_version.yml
    needs: [label-check]

  # -------------------------------------
  # ğŸ—ï¸ Build - Release AAB
  # -------------------------------------
  assemble-release:
    uses: ./.github/workflows/assemble_release_aab.yml
    needs: [get-current-version]
    secrets: inherit
    with:
      version: ${{ needs.get-current-version.outputs.version }}

  # -------------------------------------
  # ğŸš€ Deployment - Google Play Store
  # -------------------------------------
  deploy-playstore:
    uses: ./.github/workflows/playstore_deploy.yml
    needs: [assemble-release, get-current-version]
    secrets: inherit
    with:
      version: ${{ needs.get-current-version.outputs.version }}

  # -------------------------------------
  # ğŸ”– Versioning - Bump Version Code & Name
  # -------------------------------------
  version-bump:
    uses: ./.github/workflows/version_bump.yml
    needs: [deploy-playstore]
    secrets: inherit

  # -------------------------------------
  # ğŸ”– Tag - Git Tag the Release Version
  # -------------------------------------
  tag-release:
    uses: ./.github/workflows/tag_release.yml
    needs: [version-bump]
    secrets: inherit
    with:
      version: ${{ needs.version-bump.outputs.version }}
