name: Generate Baseline Profile

on: workflow_call

jobs:
  generate-baseline-profile:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Validate Gradle Wrapper
      uses: gradle/wrapper-validation-action@v1

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        cache-read-only: false

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Accept Android licenses
      run: yes | "$ANDROID_HOME"/cmdline-tools/latest/bin/sdkmanager --licenses || true

    - name: Install GMD system image
      run: |
        echo "y" | "$ANDROID_HOME"/cmdline-tools/latest/bin/sdkmanager \
          "system-images;android-34;aosp_atd;arm64-v8a" \
          "emulator" \
          "platform-tools"

    - name: Enable KVM (hardware acceleration)
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules || true
        sudo udevadm control --reload-rules || true
        sudo udevadm trigger --name-match=kvm || true

    - name: Generate Baseline Profile
      run: |
        ./gradlew :app:generateBaselineProfile \
          -Pandroid.testoptions.manageddevices.emulator.gpu="swiftshader_indirect" \
          -Pandroid.testoptions.manageddevices.emulator.showkernel=no \
          -Pandroid.testoptions.manageddevices.maxConcurrentDevices=1 \
          -Pandroid.testoptions.manageddevices.setupTimeoutMinutes=20 \
          --stacktrace
