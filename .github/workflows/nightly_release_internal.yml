name: Nightly Release Internal

on:
  schedule:
    - cron: "0 2 * * 1-4"  # Every Mon‚ÄìThu at 02:00 UTC (03:00 UK/BST)

  workflow_dispatch:

jobs:

  # ---------------------------------------------
  # üîñ Checks for Commits & Generates Release Tag
  # ---------------------------------------------
  generate-tag:
    name: Generate Release Tag
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.set-tag.outputs.RELEASE_TAG }}

    steps:
      - uses: actions/checkout@v4
      - name: Run tag release script
        id: set-tag
        run: .github/scripts/tag_release.sh

  # ----------------------------------------
  # üß© Versioning - Bump Version Code & Name
  # ----------------------------------------
  version-bump:
    name: Version Bump
    needs: generate-tag
    uses: ./.github/workflows/version_bump.yml
    secrets: inherit

  # -------------------------------------------------
  # ‚è≥ Wait for version bump PR to be merged
  # -------------------------------------------------
  wait-for-version-bump-merge:
    name: Wait for Version Bump PR to be Merged
    needs: version-bump
    runs-on: ubuntu-latest

    steps:
      - name: Install GitHub CLI
        uses: cli/cli-action@v2

      - name: Find and wait for version bump PR to merge
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
            echo "Looking for open version bump PR..."
            PR_NUMBER=$(gh pr list --state open --author "@me" --label "autoversion" --json number --jq '.[0].number')
            
            if [ -z "$PR_NUMBER" ]; then
              echo "No open version bump PR found. Exiting."
              exit 1
            fi
            
            echo "Waiting for PR #$PR_NUMBER to be merged..."
            for i in {1..30}; do
              PR_MERGED=$(gh pr view $PR_NUMBER --json merged --jq '.merged')
              if [ "$PR_MERGED" == "true" ]; then
                echo "PR #$PR_NUMBER has been merged!"
                exit 0
              fi
              echo "Still waiting... ($i/30)"
              sleep 30
            done
            
            echo "Timeout: PR was not merged in time."
            exit 1

  # ---------------------------------------------
  # üöÄ Tags the Release & Generates Release Notes
  # ---------------------------------------------
  github-release:
    name: GitHub Release
    needs: [generate-tag, wait-for-version-bump-merge]
    runs-on: ubuntu-latest

    steps:
      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          generateReleaseNotes: true
          tag: ${{ needs.generate-tag.outputs.RELEASE_TAG }}
          token: ${{ secrets.GH_TOKEN }}
